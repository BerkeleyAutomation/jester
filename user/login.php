<?php $_POST["errormessagetype"] = "html" ?><?php require_once("../includes/settings.php") ?><?php require_once("../includes/autologout.php") ?><?php require_once("../includes/constants.php") ?><?php require("../includes/errormessages.php") ?><?php require_once("../includes/dbfunctions.php") ?><?php require_once("../includes/generalfunctions.php") ?><?php require_once("../includes/authentication.php") ?><?phpfunction userAuthenticated($connection, $email){	global $errorstr;		$password = $_POST["password"];		if (empty($email) || empty($password))	{		$errorstr = "You must complete all fields to login.";		return false;	}		if ($email != mysql_real_escape_string($email))	{		$errorstr = "That email address is not valid.";		return false;	}		$passwordhash = mysql_real_escape_string(md5(trim($password)));		$query = "SELECT COUNT(*) FROM users WHERE email='{$email}'";	$result = mysql_query($query, $connection);	if (!$result)		die($_POST["preinvalidquery"] . mysql_error() . $_POST["postinvalidquery"]);			$row = mysql_fetch_row($result);	$numusers = $row[0];		//Check if no users are found	if ($numusers == 0)	{		$errorstr = "That email address is not registered.";		return false;	}	//User is found	else	{						$query = "SELECT COUNT(*) FROM users WHERE email='{$email}' AND password='{$passwordhash}'";		$result = mysql_query($query, $connection);		if (!$result)			die($_POST["preinvalidquery"] . mysql_error() . $_POST["postinvalidquery"]);					$row = mysql_fetch_row($result);		$numusersmatchingpw = $row[0];				//User is found, but password is incorrect		if ($numusersmatchingpw == 0)		{			$errorstr = "The password you entered is not valid.";			return false;		}	}	return true;}function login($connection, $email){	$userid = getUserID($connection, $email);	$sessionhash = createSessionHash($connection);		$_SESSION["userid"] = $userid;	$_SESSION["ip"] = $_SERVER["REMOTE_ADDR"];	$_SESSION["accessstring"] = "";	$_SESSION["recommendready"] = false;	$_SESSION["randomready"] = false;	$_SESSION["rerecommendready"] = false;	$_SESSION["recommendcount"] = 0;	$_SESSION["seedcount"] = 0;	$_SESSION["sessionhash"] = $sessionhash;		//Update times and lasttime in users table		$query = "SELECT times FROM users WHERE userid={$userid}";	$result = mysql_query($query, $connection);	if (!$result)   		die($_POST["preinvalidquery"] . mysql_error() . $_POST["postinvalidquery"]);		$row = mysql_fetch_row($result);	$times = $row[0];		$times++;		$query = "UPDATE users SET times='{$times}' WHERE userid={$userid}";	$result = mysql_query($query, $connection);	if (!$result)   		die($_POST["preinvalidquery"] . mysql_error() . $_POST["postinvalidquery"]);}function outputJokes(){	header("Location: ../user/jokes.php");	exit;}?><?php user_session() ?><?phpif (isset($_POST["email"]) && !userLoggedIn()){	openConnection();	$htmlerror = "";	$email = $_POST["email"];	$email = htmlspecialchars(strtolower($email), ENT_QUOTES);	if (userAuthenticated($connection, $email))	{		login($connection, $email);		outputJokes();	}	else	{		$htmlerror .= "<p class=\"error\">Error: ";		$htmlerror .= $errorstr;		$htmlerror .= "</p>";	}	mysql_close($connection);}?><?php require_once("../includes/header.php") ?><div id="navigation"><h3>Login</h3><?php require_once("../includes/navbar.php") ?></div><?phpif (isset($_POST["email"]) && !userLoggedIn()){?><div id="topnotice"><?php print $htmlerror ?></div><?php}?><div id="main"><?phpif (!userLoggedIn())	print "<p>\nIf you are a registered member, enter your registered email and password below. Please be aware that passwords are case sensitive.\n</p>";	if (!userLoggedIn()){	if (isset($_POST["email"]))		$email = htmlspecialchars($_POST["email"], ENT_QUOTES);	else		$email = "";	?>	<form action="../user/login.php" method="post">	<div id="logininput">	<p>	<span class="columnleft">Email:</span>	<span class="columnright"><input name="email" type="text" maxlength="60" value="<?php print $email ?>" /></span>	</p>	<p>	<span class="columnleft">Password:</span>	<span class="columnright"><input name="password" type="password" maxlength="30" /></span>	</p>	</div>	<p>	<input name="submit" type="submit" value="Login" />	<input name="reset" type="button" value="Reset" onclick="window.location.href = '../user/login.php'" />	</p>	</form>	<?php}else{	openConnection();		$userid = $_SESSION["userid"];	$loggedinphrase = getLoggedInPhrase($connection, $userid);			print "<p>\nYou are currently <span class=\"important\">" . $loggedinphrase . "</span>.\n</p>";		mysql_close($connection);}?><p>For questions regarding logins and passwords, contact the <a href="mailto:<?php print $webmaster ?>">webmaster</a>.</p></div><?php require_once("../includes/footer.php") ?>